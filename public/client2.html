<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="index.css" />
    <title>Client chat App</title>
  </head>

  <body>
    <div class="container">
      <p class="msg">Client:</p>
      <div id="messages" class="messages"></div>
      <form id="msgForm" class="msgForm">
        <input
          type="text"
          placeholder="Send message"
          class="input"
          id="inputBox"
        />
        <input type="submit" class="btn" value="Send" />
      </form>
    </div>
    <script type="text/javascript">
      let messages = [];
      let ws;

      const displayMessage = ({ id, author, message, created_at }) => {
        if (!document.getElementById(id)) {
          msgDiv = document.createElement("div");
          if (author === "client") {
            msgDiv.classList.add("myMessage");
          } else {
            const msg = {
              type: "UpdateMessageStatus",
              status: 2,
              message_id: id,
            };

            ws.send(JSON.stringify(msg));
          }
          msgDiv.classList.add("msgCtn");
          msgDiv.setAttribute("id", id);
          msgDiv.innerHTML = `${message}<br/><span>${created_at}</span>`;
          document.getElementById("messages").appendChild(msgDiv);
        }
      };
      const renderHistory = (messages) => {
        messages.forEach((message) => {
          displayMessage(message);
        });
      };

      const connect = () => {
        ws = new WebSocket(`ws://${window.document.location.host}/ws/client`, [
          "Authorization",
          "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImVjMDQwMjEzLTkyZTktNGU4ZS05YWIzLWFlZTg5MjY5NjZjNCIsInNlc3Npb25faWRlbnRpZmllciI6ImE0MDUwYmZkMDQ3NDU2YTg4ZTcwODUxNmY0NTZkMmIzZWU5NTE4ZTk1Y2U4ZTBjODdiMzliMWU1ZjI0OGI1YWIiLCJpYXQiOjE2OTI2MzI5Mjl9.-SHT4kdOK0-ehYhd3194MYwKVEFfCNEIb1EpixRutgCueLyMPkkmMjb-4AX1jv6KxLLtl73iW5N18StukNeJVA",
        ]);
        ws.binaryType = "blob";
        ws.addEventListener("open", (event) => {
          console.log("Websocket connection opened");
        });
        ws.addEventListener("close", (event) => {
          setTimeout(connect, 1000);
          console.log("Websocket connection closed");
        });
        ws.onmessage = ({ data }) => {
          const msg = JSON.parse(data);
          switch (msg.type) {
            case "History":
              return renderHistory(msg.messages);
            case "NewMessage":
              return displayMessage(msg.message);
          }
        };
      };
      connect();
      setTimeout(
        () =>
          ws.send(
            JSON.stringify({
              type: "History",
              created_at: Date.now(),
            })
          ),
        1000
      );

      const form = document.getElementById("msgForm");
      form.focus();
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const message = {
          type: "SubmitMessage",
          author: "client",
          status: 1,
          message: document.getElementById("inputBox").value,
        };
        ws.send(JSON.stringify(message));
        document.getElementById("inputBox").value = "";
        form.focus();
      });
    </script>
  </body>
</html>
